<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blocked Matrix Multiplication Visualizer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .matrix {
      display: inline-block;
      margin: 0 20px;
    }
    .cell {
      width: 20px;
      height: 20px;
      display: inline-block;
      text-align: center;
      vertical-align: middle;
      border: 1px solid #ccc;
    }
    .matrix-row {
        line-height: 10px;
    }
    .highlight-a { background-color: #ffeeba; }
    .highlight-b { background-color: #cce5ff; }
    .highlight-c { background-color: #d4edda; }
    .loop-tile {
      padding: 5px 10px;
      margin: 5px;
      background-color: #e9ecef;
      border: 1px solid #adb5bd;
      border-radius: 5px;
      cursor: pointer;
      position: relative;
    }
    .loop-box {
      min-height: 60px;
      border: 1px dashed #6c757d;
      padding: 10px;
    }
    .arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background-color: #adb5bd;
      color: white;
      border: none;
      padding: 0 5px;
      cursor: pointer;
      z-index: 1;
    }
    .arrow-left { left: -20px; }
    .arrow-right { right: -20px; }
  </style>
</head>
<body class="p-4" onclick="deselectTiles(event)">
  <h2 class="mb-4">Blocked Matrix Multiplication Visualizer</h2>

  <div class="row mb-4">
    <div class="col-md-3">
      <label for="matrixSize" class="form-label">Matrix Size</label>
      <select id="matrixSize" class="form-select">
        <option>2</option>
        <option>4</option>
        <option>8</option>
        <option>16</option>
        <option>32</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Tile Size for i</label>
      <select id="tileSizeI" class="form-select"></select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Tile Size for j</label>
      <select id="tileSizeJ" class="form-select"></select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Tile Size for k</label>
      <select id="tileSizeK" class="form-select"></select>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col">
      <h5>Outer Loop Order</h5>
      <div id="outerLoopBox" class="loop-box d-flex" onclick="event.stopPropagation();"></div>
    </div>
    <div class="col">
      <h5>Inner Loop Order</h5>
      <div id="innerLoopBox" class="loop-box d-flex" onclick="event.stopPropagation();"></div>
    </div>
  </div>

  <div class="d-flex justify-content-center mb-3">
    <div id="matrixA" class="matrix"></div>
    <div id="matrixB" class="matrix"></div>
    <div id="matrixC" class="matrix"></div>
  </div>

  <div class="mb-4">
    <button class="btn btn-primary me-2" onclick="initializeMatrix()">Render Matrix</button>
    <button class="btn btn-primary me-2" onclick="toggleAuto()">Start/Stop</button>
  </div>

  <script>
    const loopVars = ['i', 'j', 'k'];
    let currentStep = 0;
    let autoInterval = null;
    let loopSequence = [];
    let selectedTile = null;

    function initLoopBox(boxId) {
      const box = document.getElementById(boxId);
      box.innerHTML = '';
      loopVars.forEach(v => {
        const div = document.createElement('div');
        div.className = 'loop-tile';
        div.textContent = v;
        div.addEventListener('click', e => handleTileClick(e, boxId));
        box.appendChild(div);
      });
    }

    function handleTileClick(e, boxId) {
      e.stopPropagation();
      if (selectedTile) {
        removeArrows(selectedTile);
        selectedTile = null;
      }
      const tile = e.currentTarget;
      selectedTile = tile;
      showArrows(tile, boxId);
    }

    function showArrows(tile, boxId) {
      const parent = document.getElementById(boxId);
      const tiles = Array.from(parent.children);
      const index = tiles.indexOf(tile);

      if (index > 0) {
        const leftArrow = document.createElement('button');
        leftArrow.className = 'arrow arrow-left';
        leftHTML = '&#8592;';
        leftArrow.innerHTML = leftHTML;
        leftArrow.onclick = e => {
          e.stopPropagation();
          swapTiles(parent, index - 1, index);
        };
        tile.appendChild(leftArrow);
      }

      if (index < tiles.length - 1) {
        const rightArrow = document.createElement('button');
        rightArrow.className = 'arrow arrow-right';
        rightHTML = '&#8594;';
        rightArrow.innerHTML = rightHTML;
        rightArrow.onclick = e => {
          e.stopPropagation();
          swapTiles(parent, index, index + 1);
        };
        tile.appendChild(rightArrow);
      }
    }

    function swapTiles(parent, i, j) {
      const tiles = Array.from(parent.children);
      if (i >= 0 && j >= 0 && i < tiles.length && j < tiles.length) {
        const temp = tiles[i];
        parent.insertBefore(tiles[j], tiles[i]);
        parent.insertBefore(temp, tiles[j].nextSibling);
        removeArrows(tiles[i]);
        removeArrows(tiles[j]);
        selectedTile = null;
      }
    }

    function removeArrows(tile) {
      tile.querySelectorAll('.arrow').forEach(el => el.remove());
    }

    function deselectTiles(e) {
      if (selectedTile) {
        removeArrows(selectedTile);
        selectedTile = null;
      }
    }

    function populateTileOptions() {
      const size = +document.getElementById('matrixSize').value;
      const powers = Array.from({ length: Math.log2(size) + 1 }, (_, i) => 2 ** i);
      ['tileSizeI', 'tileSizeJ', 'tileSizeK'].forEach(id => {
        const select = document.getElementById(id);
        select.innerHTML = '';
        powers.forEach(p => {
          const opt = document.createElement('option');
          opt.text = p;
          select.add(opt);
        });
      });
    }

    function initializeMatrix() {
      const size = +document.getElementById('matrixSize').value;
      const containers = ['matrixA', 'matrixB', 'matrixC'];
      containers.forEach(id => {
        const box = document.getElementById(id);
        box.innerHTML = '';
        for (let i = 0; i < size; i++) {
          const row = document.createElement('div');
          row.className = 'matrix-row';
          for (let j = 0; j < size; j++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.id = `${id[6].toLowerCase()}-${i}-${j}`;
            row.appendChild(cell);
          }
          box.appendChild(row);
        }
      });
      currentStep = 0;
      buildLoopSequence();
    }

    function buildLoopSequence() {
      const size = +document.getElementById('matrixSize').value;
      const tileSize = {
        i: +document.getElementById('tileSizeI').value,
        j: +document.getElementById('tileSizeJ').value,
        k: +document.getElementById('tileSizeK').value
      };
      const outer = Array.from(document.getElementById('outerLoopBox').children).map(el => el.textContent);
      const inner = Array.from(document.getElementById('innerLoopBox').children).map(el => el.textContent);
      loopSequence = [];

      const range = (max, step) => Array.from({ length: Math.ceil(max / step) }, (_, i) => i * step);

      const outerSpace = {};
      outer.forEach(d => outerSpace[d] = range(size, tileSize[d]));
      const innerSpace = {};
      inner.forEach(d => innerSpace[d] = range(tileSize[d], 1));

      for (let o1 of outerSpace[outer[0]])
        for (let o2 of outerSpace[outer[1]])
          for (let o3 of outerSpace[outer[2]])
            for (let i1 = 0; i1 < tileSize[inner[0]]; i1++)
              for (let i2 = 0; i2 < tileSize[inner[1]]; i2++)
                for (let i3 = 0; i3 < tileSize[inner[2]]; i3++) {
                  const ctx = { i: 0, j: 0, k: 0 };
                  ctx[outer[0]] = o1;
                  ctx[outer[1]] = o2;
                  ctx[outer[2]] = o3;
                  ctx[inner[0]] += i1;
                  ctx[inner[1]] += i2;
                  ctx[inner[2]] += i3;
                  if (ctx.i < size && ctx.j < size && ctx.k < size)
                    loopSequence.push([ctx.i, ctx.j, ctx.k]);
                }
    }

    function nextStep() {
      if (currentStep >= loopSequence.length) currentStep = 0;
      const [i, j, k] = loopSequence[currentStep];
      document.querySelectorAll('.cell').forEach(c => c.classList.remove('highlight-a', 'highlight-b', 'highlight-c'));
      document.getElementById(`a-${i}-${k}`)?.classList.add('highlight-a');
      document.getElementById(`b-${k}-${j}`)?.classList.add('highlight-b');
      document.getElementById(`c-${i}-${j}`)?.classList.add('highlight-c');
      currentStep++;
    }

    function toggleAuto() {
      if (!autoInterval) autoInterval = setInterval(nextStep, 50);
      else {
        clearInterval(autoInterval);
        autoInterval = null;
      }
    }

    document.getElementById('matrixSize').addEventListener('change', populateTileOptions);
    window.onload = () => {
      initLoopBox('outerLoopBox');
      initLoopBox('innerLoopBox');
      populateTileOptions();
    };
  </script>
</body>
</html>
